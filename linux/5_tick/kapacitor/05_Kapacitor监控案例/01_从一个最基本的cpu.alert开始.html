<!DOCTYPE html>
<html lang="zh-cn">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8">
  <title>05-Kapacitor监控案例-A-从一个最基本的cpu.alert开始 | BoobooWei</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
</script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.toberoot.com/linux/5_tick/kapacitor/05_Kapacitor%E7%9B%91%E6%8E%A7%E6%A1%88%E4%BE%8B/01_%E4%BB%8E%E4%B8%80%E4%B8%AA%E6%9C%80%E5%9F%BA%E6%9C%AC%E7%9A%84cpu.alert%E5%BC%80%E5%A7%8B.html">
  <!-- Alternative links -->
  
    
      <link rel="alternative" hreflang="zh-cn" href="http://www.toberoot.com/zh-cn/linux/5_tick/kapacitor/05_Kapacitor%E7%9B%91%E6%8E%A7%E6%A1%88%E4%BE%8B/01_%E4%BB%8E%E4%B8%80%E4%B8%AA%E6%9C%80%E5%9F%BA%E6%9C%AC%E7%9A%84cpu.alert%E5%BC%80%E5%A7%8B">
    
  
  <!-- Icon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/icon/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icon/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icon/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icon/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icon/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icon/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icon/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/icon/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/icon/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/icon/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/icon/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/icon/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#2f83cd">
  <meta name="msapplication-TileImage" content="/icon/mstile-144x144.png">
  <!-- CSS -->
  <!-- build:css build/css/navy.css -->
  
<link rel="stylesheet" href="/css/navy.css">

  <!-- endbuild -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-lato@0.0.75/index.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css">
  <!-- RSS -->
  <link rel="alternate" href="/atom.xml" title="BoobooWei" type="application/atom+xml">
  <!-- Open Graph -->
  <meta name="description" content="CPU Alert 开始之前 示范数据 Tickscript 语言 基础命令   创建一个最简单的 Stream Task Stream Task 要求 解题过程 1. 画出DAG图 2. 编写 TICKscript 3. 声明脚本 4. 查看Task     创建一个包含数据库声明的 Stream Task Stream Task 要求 解题过程 1. 画出DAG图 2. 编写 TICKsc">
<meta property="og:type" content="website">
<meta property="og:title" content="05-Kapacitor监控案例-A-从一个最基本的cpu.alert开始">
<meta property="og:url" content="http://www.toberoot.com/linux/5_tick/kapacitor/05_Kapacitor%E7%9B%91%E6%8E%A7%E6%A1%88%E4%BE%8B/01_%E4%BB%8E%E4%B8%80%E4%B8%AA%E6%9C%80%E5%9F%BA%E6%9C%AC%E7%9A%84cpu.alert%E5%BC%80%E5%A7%8B">
<meta property="og:site_name" content="BoobooWei">
<meta property="og:description" content="CPU Alert 开始之前 示范数据 Tickscript 语言 基础命令   创建一个最简单的 Stream Task Stream Task 要求 解题过程 1. 画出DAG图 2. 编写 TICKscript 3. 声明脚本 4. 查看Task     创建一个包含数据库声明的 Stream Task Stream Task 要求 解题过程 1. 画出DAG图 2. 编写 TICKsc">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-04-14T11:31:51.000Z">
<meta property="article:modified_time" content="2022-03-22T03:27:48.277Z">
<meta property="article:author" content="魏亚萍">
<meta property="article:tag" content="监控告警">
<meta property="article:tag" content="TICK技术栈">
<meta property="article:tag" content="TICK技术栈之kapacitor监控案例">
<meta name="twitter:card" content="summary">
<meta property="fb:admins" content="100000247608790">
  <!-- Google Analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48498357-3', 'auto');
  ga('send', 'pageview');
</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-6482217598104186",
          enable_page_level_ads: true
     });
  </script>
  <!-- at the end of the HEAD -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
<meta name="generator" content="Hexo 6.1.0"></head>

<body>
  <div id="container">
    <header id="header" class="wrapper">
  <div id="header-inner" class="inner">
    <h1 id="logo-wrap">
      <a href='/' id="logo">ToBeRoot</a>
    </h1>
    <nav id="main-nav">
      <a href="/api/" class="main-nav-link">MySQL8.0</a><a href="/database/" class="main-nav-link">Database</a><a href="/devops/" class="main-nav-link">DevOps</a><a href="/linux/" class="main-nav-link">Linux</a><a href="/cloud/" class="main-nav-link">Cloud</a><a href="/mse/" class="main-nav-link">MSE</a><a href="/singapore/" class="main-nav-link">Singapore</a><a href="/news/" class="main-nav-link">News</a>
      <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/BoobooWei" class="main-nav-link"><i class="fa fa-github-alt"></i></a>
      <div id="search-input-wrap">
        <div id="search-input-icon">
          <i class="fa fa-search"></i>
        </div>
        <input type="search" id="search-input" placeholder="Search...">
      </div>
    </nav>
    <div id="lang-select-wrap">
      <a href="/themes/" class="main-nav-link"><label id="lang-select-label"><i class="fa fa-globe"></i><span>技术广角</span></label></a>
    </div>


    <a id="mobile-nav-toggle">
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
    </a>
  </div>
</header>

    <div id="content-wrap">
  <div id="content" class="wrapper">
    <div id="content-inner">
      <article class="article-container" itemscope itemtype="http://schema.org/Article">
        <div class="article-inner">
          <div class="article">
            <div class="inner">
              <header class="article-header">
                <h1 class="article-title" itemprop="name">05-Kapacitor监控案例-A-从一个最基本的cpu.alert开始</h1>
                <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/booboowei/site/edit/master/source/linux/5_tick/kapacitor/05_Kapacitor监控案例/01_从一个最基本的cpu.alert开始.md" class="article-edit-link" title="改进本文"><i class="fa fa-pencil"></i></a>
              </header>
              <div class="article-content" itemprop="articleBody">
                <!-- TOC depthFrom:1 depthTo:6 withLinks:1 updateOnSave:1 orderedList:0 -->
<ul>
<li><a href="#cpu-alert">CPU Alert</a><ul>
<li><a href="#开始之前">开始之前</a><ul>
<li><a href="#示范数据">示范数据</a></li>
<li><a href="#tickscript-语言">Tickscript 语言</a></li>
<li><a href="#基础命令">基础命令</a></li>
</ul>
</li>
<li><a href="#创建一个最简单的-stream-task">创建一个最简单的 Stream Task</a><ul>
<li><a href="#stream-task-要求">Stream Task 要求</a></li>
<li><a href="#解题过程">解题过程</a><ul>
<li><a href="#1-画出dag图">1. 画出DAG图</a></li>
<li><a href="#2-编写-tickscript">2. 编写 TICKscript</a></li>
<li><a href="#3-声明脚本">3. 声明脚本</a></li>
<li><a href="#4-查看task">4. 查看Task</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#创建一个包含数据库声明的-stream-task">创建一个包含数据库声明的 Stream Task</a><ul>
<li><a href="#stream-task-要求">Stream Task 要求</a></li>
<li><a href="#解题过程">解题过程</a><ul>
<li><a href="#1-画出dag图">1. 画出DAG图</a></li>
<li><a href="#2-编写-tickscript">2. 编写 TICKscript</a></li>
<li><a href="#3-声明脚本">3. 声明脚本</a></li>
<li><a href="#4-查看task">4. 查看Task</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#启动-cpu-task-任务">启动 CPU Task 任务</a><ul>
<li><a href="#任务说明">任务说明</a></li>
<li><a href="#课堂练习">课堂练习</a></li>
</ul>
</li>
<li><a href="#停止-cpu-task-任务">停止 CPU Task 任务</a><ul>
<li><a href="#任务说明">任务说明</a></li>
<li><a href="#课堂练习">课堂练习</a></li>
</ul>
</li>
<li><a href="#创建一个带时间窗口的-stream-task">创建一个带时间窗口的 Stream Task</a><ul>
<li><a href="#stream-task-要求">Stream Task 要求</a></li>
<li><a href="#解题过程">解题过程</a><ul>
<li><a href="#1-画出dag图">1. 画出DAG图</a></li>
<li><a href="#2-编写-tickscript">2. 编写 TICKscript</a></li>
<li><a href="#3-声明脚本">3. 声明脚本</a></li>
<li><a href="#4-启动task">4. 启动Task</a></li>
<li><a href="#5-查看task列表">5. 查看Task列表</a></li>
<li><a href="#6-查看task任务明细">6. 查看Task任务明细</a></li>
<li><a href="#7-查看task日志">7. 查看Task日志</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#创建一个带过滤条件的-stream-task">创建一个带过滤条件的 Stream Task</a><ul>
<li><a href="#stream-task-要求">Stream Task 要求</a></li>
<li><a href="#解题过程">解题过程</a><ul>
<li><a href="#第一种解法">第一种解法</a></li>
<li><a href="#第二种解法">第二种解法</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#创建一个可以触发告警的-stream-task">创建一个可以触发告警的 Stream Task</a><ul>
<li><a href="#stream-task-要求">Stream Task 要求</a></li>
<li><a href="#解题过程">解题过程</a><ul>
<li><a href="#1-画出dag图">1. 画出DAG图</a></li>
<li><a href="#2-编写-tickscript">2. 编写 TICKscript</a></li>
<li><a href="#3-启动后查看日志">3. 启动后查看日志</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#创建一个批处理的cpu任务">创建一个批处理的CPU任务</a><ul>
<li><a href="#batch-task-要求">Batch Task  要求</a></li>
<li><a href="#解题过程">解题过程</a><ul>
<li><a href="#1-画出dag图">1. 画出DAG图</a></li>
<li><a href="#2-编写-tickscript">2. 编写 TICKscript</a></li>
<li><a href="#3-启动后查看日志">3. 启动后查看日志</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#总结">总结</a><ul>
<li><a href="#创建一个生产环境中设定的告警规则">创建一个生产环境中设定的告警规则</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="从一个最基本的CPU-Alert开始" class="article-heading"><a href="#从一个最基本的CPU-Alert开始" class="headerlink" title="从一个最基本的CPU Alert开始"></a>从一个最基本的CPU Alert开始<a class="article-anchor" href="#从一个最基本的CPU-Alert开始" aria-hidden="true"></a></h1><h2 id="开始之前" class="article-heading"><a href="#开始之前" class="headerlink" title="开始之前"></a>开始之前<a class="article-anchor" href="#开始之前" aria-hidden="true"></a></h2><h3 id="示范数据" class="article-heading"><a href="#示范数据" class="headerlink" title="示范数据"></a>示范数据<a class="article-anchor" href="#示范数据" aria-hidden="true"></a></h3><p>InfluxDB 数据库中<code>telegraf.autogen.cpu</code>的数据点示范</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@tick:/var/lib/kapacitor/task]<span class="comment"># zy_influx -format &#x27;csv&#x27; -database telegraf -execute &#x27;select * from cpu limit 1&#x27;</span></span><br><span class="line">name,time,cpu,host,usage_guest,usage_guest_nice,usage_idle,usage_iowait,usage_irq,usage_nice,usage_softirq,usage_steal,usage_system,usage_user</span><br><span class="line">cpu,1564963200000000000,cpu-total,influxdb,0,0,99.03894367190544,0.158783219116127,0,0,0.008357011532397735,0,0.2757813805708354,0.5181347150052392</span><br><span class="line">cpu,1564963260000000000,cpu-total,influxdb,0,0,98.7377748073443,0.20061857394411767,0,0,0.00835910724767157,0,0.3092869681602368,0.7439605450429597</span><br></pre></td></tr></table></figure>
<p><strong>Tag keys</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@tick:/var/lib/kapacitor/task]<span class="comment"># zy_influx -format &#x27;csv&#x27; -database telegraf -execute &#x27;show tag keys from cpu&#x27;</span></span><br><span class="line">name,tagKey</span><br><span class="line">cpu,cpu</span><br><span class="line">cpu,host</span><br></pre></td></tr></table></figure>
<p><strong>Field keys</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@tick:/var/lib/kapacitor/task]<span class="comment"># zy_influx -format &#x27;csv&#x27; -database telegraf -execute &#x27;show field keys from cpu&#x27;</span></span><br><span class="line">name,fieldKey,fieldType</span><br><span class="line">cpu,usage_guest,<span class="built_in">float</span></span><br><span class="line">cpu,usage_guest_nice,<span class="built_in">float</span></span><br><span class="line">cpu,usage_idle,<span class="built_in">float</span></span><br><span class="line">cpu,usage_iowait,<span class="built_in">float</span></span><br><span class="line">cpu,usage_irq,<span class="built_in">float</span></span><br><span class="line">cpu,usage_nice,<span class="built_in">float</span></span><br><span class="line">cpu,usage_softirq,<span class="built_in">float</span></span><br><span class="line">cpu,usage_steal,<span class="built_in">float</span></span><br><span class="line">cpu,usage_system,<span class="built_in">float</span></span><br><span class="line">cpu,usage_user,<span class="built_in">float</span></span><br></pre></td></tr></table></figure>
<h3 id="Tickscript-语言" class="article-heading"><a href="#Tickscript-语言" class="headerlink" title="Tickscript 语言"></a>Tickscript 语言<a class="article-anchor" href="#Tickscript-语言" aria-hidden="true"></a></h3><p><a href="[https://github.com/BoobooWei/booboo_TimeSeriesDBMS/tree/master/Kapacitor/02_TICKscript%E8%AF%AD%E8%A8%80](https://github.com/BoobooWei/booboo_TimeSeriesDBMS/tree/master/Kapacitor/02_TICKscript语言">学习教程</a>)</p>
<h3 id="基础命令" class="article-heading"><a href="#基础命令" class="headerlink" title="基础命令"></a>基础命令<a class="article-anchor" href="#基础命令" aria-hidden="true"></a></h3><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.influxdata.com/kapacitor/v1.5/working/cli_client/">官方帮助</a></p>
<h2 id="创建一个最简单的-Stream-Task" class="article-heading"><a href="#创建一个最简单的-Stream-Task" class="headerlink" title="创建一个最简单的 Stream Task"></a>创建一个最简单的 Stream Task<a class="article-anchor" href="#创建一个最简单的-Stream-Task" aria-hidden="true"></a></h2><h3 id="Stream-Task-要求" class="article-heading"><a href="#Stream-Task-要求" class="headerlink" title="Stream Task 要求"></a>Stream Task 要求<a class="article-anchor" href="#Stream-Task-要求" aria-hidden="true"></a></h3><p>流式获取 Influxdb数据库中</p>
<ul>
<li>库名<code>database</code>：<code>telegraf</code>.<code>autogen</code></li>
<li>测量名<code>measurement</code>：<code>cpu</code></li>
</ul>
<p>的数据点，输出到日志中。</p>
<h3 id="解题过程" class="article-heading"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程<a class="article-anchor" href="#解题过程" aria-hidden="true"></a></h3><h4 id="1-画出DAG图" class="article-heading"><a href="#1-画出DAG图" class="headerlink" title="1. 画出DAG图"></a>1. 画出DAG图<a class="article-anchor" href="#1-画出DAG图" aria-hidden="true"></a></h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">graph LR;</span><br><span class="line">  A(StreamNode)--&gt;B</span><br><span class="line">  B(FromNode)--&gt;C</span><br><span class="line">  C(LogNode)</span><br></pre></td></tr></table></figure>
<h4 id="2-编写-TICKscript" class="article-heading"><a href="#2-编写-TICKscript" class="headerlink" title="2. 编写 TICKscript"></a>2. 编写 TICKscript<a class="article-anchor" href="#2-编写-TICKscript" aria-hidden="true"></a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//cpu.tick</span></span><br><span class="line">stream</span><br><span class="line">  |<span class="title function_">from</span>()</span><br><span class="line">    .<span class="title function_">measurement</span>(<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">  |<span class="title function_">log</span>()</span><br></pre></td></tr></table></figure>
<h4 id="3-声明脚本" class="article-heading"><a href="#3-声明脚本" class="headerlink" title="3. 声明脚本"></a>3. 声明脚本<a class="article-anchor" href="#3-声明脚本" aria-hidden="true"></a></h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kapacitor define cpu -tick cpu.tick -dbrp telegraf.autogen</span><br></pre></td></tr></table></figure>
<h4 id="4-查看Task" class="article-heading"><a href="#4-查看Task" class="headerlink" title="4. 查看Task"></a>4. 查看Task<a class="article-anchor" href="#4-查看Task" aria-hidden="true"></a></h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kapacitor list tasks</span><br></pre></td></tr></table></figure>
<h2 id="创建一个包含数据库声明的-Stream-Task" class="article-heading"><a href="#创建一个包含数据库声明的-Stream-Task" class="headerlink" title="创建一个包含数据库声明的 Stream Task"></a>创建一个包含数据库声明的 Stream Task<a class="article-anchor" href="#创建一个包含数据库声明的-Stream-Task" aria-hidden="true"></a></h2><h3 id="Stream-Task-要求-1" class="article-heading"><a href="#Stream-Task-要求-1" class="headerlink" title="Stream Task 要求"></a>Stream Task 要求<a class="article-anchor" href="#Stream-Task-要求-1" aria-hidden="true"></a></h3><p>流式获取 Influxdb数据库中</p>
<ul>
<li>库名<code>database</code>：<code>telegraf</code>.<code>autogen</code></li>
<li>测量名<code>measurement</code>：<code>cpu</code></li>
</ul>
<p>的数据点，输出到日志中。</p>
<h3 id="解题过程-1" class="article-heading"><a href="#解题过程-1" class="headerlink" title="解题过程"></a>解题过程<a class="article-anchor" href="#解题过程-1" aria-hidden="true"></a></h3><h4 id="1-画出DAG图-1" class="article-heading"><a href="#1-画出DAG图-1" class="headerlink" title="1. 画出DAG图"></a>1. 画出DAG图<a class="article-anchor" href="#1-画出DAG图-1" aria-hidden="true"></a></h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">graph LR;</span><br><span class="line">  A(StreamNode)--&gt;B</span><br><span class="line">  B(FromNode)--&gt;C</span><br><span class="line">  C(LogNode)</span><br></pre></td></tr></table></figure>
<h4 id="2-编写-TICKscript-1" class="article-heading"><a href="#2-编写-TICKscript-1" class="headerlink" title="2. 编写 TICKscript"></a>2. 编写 TICKscript<a class="article-anchor" href="#2-编写-TICKscript-1" aria-hidden="true"></a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//cpu.tick</span></span><br><span class="line">dbrp <span class="string">&quot;telegraf&quot;</span>.<span class="string">&quot;autogen&quot;</span></span><br><span class="line"></span><br><span class="line">stream</span><br><span class="line">  |<span class="title function_">from</span>()</span><br><span class="line">		.<span class="title function_">measurement</span>(<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">	|<span class="title function_">log</span>()</span><br></pre></td></tr></table></figure>
<h4 id="3-声明脚本-1" class="article-heading"><a href="#3-声明脚本-1" class="headerlink" title="3. 声明脚本"></a>3. 声明脚本<a class="article-anchor" href="#3-声明脚本-1" aria-hidden="true"></a></h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kapacitor define cpu -tick cpu.tick</span><br></pre></td></tr></table></figure>
<h4 id="4-查看Task-1" class="article-heading"><a href="#4-查看Task-1" class="headerlink" title="4. 查看Task"></a>4. 查看Task<a class="article-anchor" href="#4-查看Task-1" aria-hidden="true"></a></h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kapacitor list tasks</span><br></pre></td></tr></table></figure>
<h2 id="启动-CPU-Task-任务" class="article-heading"><a href="#启动-CPU-Task-任务" class="headerlink" title="启动 CPU Task 任务"></a>启动 CPU Task 任务<a class="article-anchor" href="#启动-CPU-Task-任务" aria-hidden="true"></a></h2><h3 id="任务说明" class="article-heading"><a href="#任务说明" class="headerlink" title="任务说明"></a>任务说明<a class="article-anchor" href="#任务说明" aria-hidden="true"></a></h3><p>通过执行<code>kapacitor enable &lt;TASK_ID&gt; &lt;TASK_ID&gt;..</code>命令启动 <code>cpu</code>任务。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kapacitor <span class="built_in">enable</span> cpu</span><br></pre></td></tr></table></figure>
<p>执行<code>kapacitor show &lt;TASK_ID&gt;</code> 查看任务状态。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kapacitor show cpu</span><br></pre></td></tr></table></figure>
<h3 id="课堂练习" class="article-heading"><a href="#课堂练习" class="headerlink" title="课堂练习"></a>课堂练习<a class="article-anchor" href="#课堂练习" aria-hidden="true"></a></h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@tick:/var/lib/kapacitor/task]<span class="comment"># kapacitor enable cpu</span></span><br><span class="line">[root@tick:/var/lib/kapacitor/task]<span class="comment"># kapacitor list cpu</span></span><br><span class="line">cannot list <span class="string">&#x27;cpu&#x27;</span> did you mean <span class="string">&#x27;tasks&#x27;</span>, <span class="string">&#x27;recordings&#x27;</span>, <span class="string">&#x27;replays&#x27;</span>, <span class="string">&#x27;topics&#x27;</span>, <span class="string">&#x27;topic-handlers&#x27;</span> or <span class="string">&#x27;service-tests&#x27;</span>?</span><br><span class="line">[root@tick:/var/lib/kapacitor/task]<span class="comment"># kapacitor show cpu</span></span><br><span class="line">ID: cpu</span><br><span class="line">Error:</span><br><span class="line">Template:</span><br><span class="line">Type: stream</span><br><span class="line">Status: enabled</span><br><span class="line">Executing: <span class="literal">true</span></span><br><span class="line">Created: 08 Sep 19 20:43 CST</span><br><span class="line">Modified: 08 Sep 19 20:43 CST</span><br><span class="line">LastEnabled: 08 Sep 19 20:43 CST</span><br><span class="line">Databases Retention Policies: [<span class="string">&quot;telegraf&quot;</span>.<span class="string">&quot;autogen&quot;</span>]</span><br><span class="line">TICKscript:</span><br><span class="line">dbrp <span class="string">&quot;telegraf&quot;</span>.<span class="string">&quot;autogen&quot;</span></span><br><span class="line"></span><br><span class="line">stream</span><br><span class="line">    |from()</span><br><span class="line">        .measurement(<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">    |<span class="built_in">log</span>()</span><br><span class="line"></span><br><span class="line">DOT:</span><br><span class="line">digraph cpu &#123;</span><br><span class="line">graph [throughput=<span class="string">&quot;0.00 points/s&quot;</span>];</span><br><span class="line"></span><br><span class="line">stream0 [avg_exec_time_ns=<span class="string">&quot;0s&quot;</span> errors=<span class="string">&quot;0&quot;</span> working_cardinality=<span class="string">&quot;0&quot;</span> ];</span><br><span class="line">stream0 -&gt; from1 [processed=<span class="string">&quot;2&quot;</span>];</span><br><span class="line"></span><br><span class="line">from1 [avg_exec_time_ns=<span class="string">&quot;0s&quot;</span> errors=<span class="string">&quot;0&quot;</span> working_cardinality=<span class="string">&quot;0&quot;</span> ];</span><br><span class="line">from1 -&gt; log2 [processed=<span class="string">&quot;2&quot;</span>];</span><br><span class="line"></span><br><span class="line">log2 [avg_exec_time_ns=<span class="string">&quot;0s&quot;</span> errors=<span class="string">&quot;0&quot;</span> working_cardinality=<span class="string">&quot;0&quot;</span> ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="停止-CPU-Task-任务" class="article-heading"><a href="#停止-CPU-Task-任务" class="headerlink" title="停止 CPU Task 任务"></a>停止 CPU Task 任务<a class="article-anchor" href="#停止-CPU-Task-任务" aria-hidden="true"></a></h2><h3 id="任务说明-1" class="article-heading"><a href="#任务说明-1" class="headerlink" title="任务说明"></a>任务说明<a class="article-anchor" href="#任务说明-1" aria-hidden="true"></a></h3><p>通过执行<code>kapacitor disable &lt;TASK_ID&gt; &lt;TASK_ID&gt;..</code>命令停止 <code>cpu</code>任务。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kapacitor <span class="built_in">disable</span> cpu</span><br></pre></td></tr></table></figure>
<p>执行<code>kapacitor show &lt;TASK_ID&gt;</code> 查看任务状态。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kapacitor show cpu</span><br></pre></td></tr></table></figure>
<h3 id="课堂练习-1" class="article-heading"><a href="#课堂练习-1" class="headerlink" title="课堂练习"></a>课堂练习<a class="article-anchor" href="#课堂练习-1" aria-hidden="true"></a></h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@tick:/var/lib/kapacitor/task]<span class="comment"># kapacitor disable cpu</span></span><br><span class="line">[root@tick:/var/lib/kapacitor/task]<span class="comment"># kapacitor show cpu</span></span><br><span class="line">ID: cpu</span><br><span class="line">Error:</span><br><span class="line">Template:</span><br><span class="line">Type: stream</span><br><span class="line">Status: disabled</span><br><span class="line">Executing: <span class="literal">false</span></span><br><span class="line">Created: 08 Sep 19 20:43 CST</span><br><span class="line">Modified: 08 Sep 19 20:46 CST</span><br><span class="line">LastEnabled: 08 Sep 19 20:43 CST</span><br><span class="line">Databases Retention Policies: [<span class="string">&quot;telegraf&quot;</span>.<span class="string">&quot;autogen&quot;</span>]</span><br><span class="line">TICKscript:</span><br><span class="line">dbrp <span class="string">&quot;telegraf&quot;</span>.<span class="string">&quot;autogen&quot;</span></span><br><span class="line"></span><br><span class="line">stream</span><br><span class="line">    |from()</span><br><span class="line">        .measurement(<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">    |<span class="built_in">log</span>()</span><br><span class="line"></span><br><span class="line">DOT:</span><br><span class="line">digraph cpu &#123;</span><br><span class="line">stream0 -&gt; from1;</span><br><span class="line">from1 -&gt; log2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="创建一个带时间窗口的-Stream-Task" class="article-heading"><a href="#创建一个带时间窗口的-Stream-Task" class="headerlink" title="创建一个带时间窗口的 Stream Task"></a>创建一个带时间窗口的 Stream Task<a class="article-anchor" href="#创建一个带时间窗口的-Stream-Task" aria-hidden="true"></a></h2><h3 id="Stream-Task-要求-2" class="article-heading"><a href="#Stream-Task-要求-2" class="headerlink" title="Stream Task 要求"></a>Stream Task 要求<a class="article-anchor" href="#Stream-Task-要求-2" aria-hidden="true"></a></h3><p>流式获取 Influxdb数据库中</p>
<ul>
<li>库名<code>database</code>：<code>telegraf</code>.<code>autogen</code></li>
<li><p>测量名<code>measurement</code>：<code>cpu</code></p>
</li>
<li><p>时间窗口为：<code>10min</code></p>
</li>
<li><p>计算<code>usage_user</code>每5分钟的平均值</p>
</li>
</ul>
<p>输出到日志中。</p>
<h3 id="解题过程-2" class="article-heading"><a href="#解题过程-2" class="headerlink" title="解题过程"></a>解题过程<a class="article-anchor" href="#解题过程-2" aria-hidden="true"></a></h3><h4 id="1-画出DAG图-2" class="article-heading"><a href="#1-画出DAG图-2" class="headerlink" title="1. 画出DAG图"></a>1. 画出DAG图<a class="article-anchor" href="#1-画出DAG图-2" aria-hidden="true"></a></h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">graph LR;</span><br><span class="line">  A(StreamNode)--&gt;B</span><br><span class="line">  B(FromNode)--&gt;C</span><br><span class="line">  C(WindowNode)--&gt;D</span><br><span class="line">  D(InfluxQLNode)--&gt;E</span><br><span class="line">  E(LogNode)</span><br></pre></td></tr></table></figure>
<h4 id="2-编写-TICKscript-2" class="article-heading"><a href="#2-编写-TICKscript-2" class="headerlink" title="2. 编写 TICKscript"></a>2. 编写 TICKscript<a class="article-anchor" href="#2-编写-TICKscript-2" aria-hidden="true"></a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//cpu.tick</span></span><br><span class="line">dbrp <span class="string">&quot;telegraf&quot;</span>.<span class="string">&quot;autogen&quot;</span></span><br><span class="line"></span><br><span class="line">stream</span><br><span class="line">  |<span class="title function_">from</span>()</span><br><span class="line">    .<span class="title function_">measurement</span>(<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">  |<span class="title function_">window</span>()</span><br><span class="line">    .<span class="title function_">period</span>(10m)</span><br><span class="line">    .<span class="title function_">every</span>(5m)</span><br><span class="line">  |<span class="title function_">mean</span>(<span class="string">&#x27;usage_user&#x27;</span>)</span><br><span class="line">    .<span class="title function_">as</span>(<span class="string">&#x27;mean_usage_user&#x27;</span>)</span><br><span class="line">  |<span class="title function_">log</span>()</span><br></pre></td></tr></table></figure>
<p><code>10 minute</code> 的时间窗口，每5分钟计算一次5分钟的平均值。</p>
<h4 id="3-声明脚本-2" class="article-heading"><a href="#3-声明脚本-2" class="headerlink" title="3. 声明脚本"></a>3. 声明脚本<a class="article-anchor" href="#3-声明脚本-2" aria-hidden="true"></a></h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kapacitor define cpu -tick cpu.tick</span><br></pre></td></tr></table></figure>
<h4 id="4-启动Task" class="article-heading"><a href="#4-启动Task" class="headerlink" title="4. 启动Task"></a>4. 启动Task<a class="article-anchor" href="#4-启动Task" aria-hidden="true"></a></h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kapacitor <span class="built_in">enable</span> cpu</span><br></pre></td></tr></table></figure>
<h4 id="5-查看Task列表" class="article-heading"><a href="#5-查看Task列表" class="headerlink" title="5. 查看Task列表"></a>5. 查看Task列表<a class="article-anchor" href="#5-查看Task列表" aria-hidden="true"></a></h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kapacitor list tasks</span><br></pre></td></tr></table></figure>
<h4 id="6-查看Task任务明细" class="article-heading"><a href="#6-查看Task任务明细" class="headerlink" title="6. 查看Task任务明细"></a>6. 查看Task任务明细<a class="article-anchor" href="#6-查看Task任务明细" aria-hidden="true"></a></h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kapacitor show cpu</span><br></pre></td></tr></table></figure>
<h4 id="7-查看Task日志" class="article-heading"><a href="#7-查看Task日志" class="headerlink" title="7. 查看Task日志"></a>7. 查看Task日志<a class="article-anchor" href="#7-查看Task日志" aria-hidden="true"></a></h4><p><code>kapacitor watch &lt;TASK_ID&gt;</code>命令遵循与<strong>任务</strong>关联的日志</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@tick:/var/lib/kapacitor]<span class="comment"># kapacitor show cpu</span></span><br><span class="line">ID: cpu</span><br><span class="line">Error:</span><br><span class="line">Template:</span><br><span class="line">Type: stream</span><br><span class="line">Status: enabled</span><br><span class="line">Executing: <span class="literal">true</span></span><br><span class="line">Created: 08 Sep 19 20:43 CST</span><br><span class="line">Modified: 08 Sep 19 21:00 CST</span><br><span class="line">LastEnabled: 08 Sep 19 21:00 CST</span><br><span class="line">Databases Retention Policies: [<span class="string">&quot;telegraf&quot;</span>.<span class="string">&quot;autogen&quot;</span>]</span><br><span class="line">TICKscript:</span><br><span class="line">// cpu.tick</span><br><span class="line">dbrp <span class="string">&quot;telegraf&quot;</span>.<span class="string">&quot;autogen&quot;</span></span><br><span class="line"></span><br><span class="line">stream</span><br><span class="line">    |from()</span><br><span class="line">        .measurement(<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">    |window()</span><br><span class="line">        .period(5m)</span><br><span class="line">        .every(1m)</span><br><span class="line">    |mean(<span class="string">&#x27;usage_user&#x27;</span>)</span><br><span class="line">        .as(<span class="string">&#x27;mean_usage_user&#x27;</span>)</span><br><span class="line">    |<span class="built_in">log</span>()</span><br><span class="line"></span><br><span class="line">DOT:</span><br><span class="line">digraph cpu &#123;</span><br><span class="line">graph [throughput=<span class="string">&quot;0.00 points/s&quot;</span>];</span><br><span class="line"></span><br><span class="line">stream0 [avg_exec_time_ns=<span class="string">&quot;0s&quot;</span> errors=<span class="string">&quot;0&quot;</span> working_cardinality=<span class="string">&quot;0&quot;</span> ];</span><br><span class="line">stream0 -&gt; from1 [processed=<span class="string">&quot;7&quot;</span>];</span><br><span class="line"></span><br><span class="line">from1 [avg_exec_time_ns=<span class="string">&quot;0s&quot;</span> errors=<span class="string">&quot;0&quot;</span> working_cardinality=<span class="string">&quot;0&quot;</span> ];</span><br><span class="line">from1 -&gt; window2 [processed=<span class="string">&quot;7&quot;</span>];</span><br><span class="line"></span><br><span class="line">window2 [avg_exec_time_ns=<span class="string">&quot;9.195µs&quot;</span> errors=<span class="string">&quot;0&quot;</span> working_cardinality=<span class="string">&quot;1&quot;</span> ];</span><br><span class="line">window2 -&gt; mean3 [processed=<span class="string">&quot;6&quot;</span>];</span><br><span class="line"></span><br><span class="line">mean3 [avg_exec_time_ns=<span class="string">&quot;0s&quot;</span> errors=<span class="string">&quot;0&quot;</span> working_cardinality=<span class="string">&quot;1&quot;</span> ];</span><br><span class="line">mean3 -&gt; log4 [processed=<span class="string">&quot;6&quot;</span>];</span><br><span class="line"></span><br><span class="line">log4 [avg_exec_time_ns=<span class="string">&quot;0s&quot;</span> errors=<span class="string">&quot;0&quot;</span> working_cardinality=<span class="string">&quot;0&quot;</span> ];</span><br><span class="line">&#125;</span><br><span class="line">[root@tick:/var/lib/kapacitor]<span class="comment"># kapacitor watch cpu</span></span><br><span class="line">ts=2019-09-08T21:14:10.014+08:00 lvl=info msg=point service=kapacitor task_master=main task=cpu node=log4 prefix= name=cpu db= rp= group=   field_mean_usage_user=1.172135513652473 time=2019-09-08T13:14:00Z</span><br><span class="line">ts=2019-09-08T21:15:10.014+08:00 lvl=info msg=point service=kapacitor task_master=main task=cpu node=log4 prefix= name=cpu db= rp= group=   field_mean_usage_user=1.0886898609303208 time=2019-09-08T13:15:00Z</span><br><span class="line">[root@tick:/var/lib/kapacitor]<span class="comment"># kapacitor disable cpu</span></span><br></pre></td></tr></table></figure>
<h2 id="创建一个带过滤条件的-Stream-Task" class="article-heading"><a href="#创建一个带过滤条件的-Stream-Task" class="headerlink" title="创建一个带过滤条件的 Stream Task"></a>创建一个带过滤条件的 Stream Task<a class="article-anchor" href="#创建一个带过滤条件的-Stream-Task" aria-hidden="true"></a></h2><h3 id="Stream-Task-要求-3" class="article-heading"><a href="#Stream-Task-要求-3" class="headerlink" title="Stream Task 要求"></a>Stream Task 要求<a class="article-anchor" href="#Stream-Task-要求-3" aria-hidden="true"></a></h3><p>在之前<code>cpu</code>任务的基础上，过滤<code>tag</code>，<code>cpu = cpu-total</code>的值</p>
<h3 id="解题过程-3" class="article-heading"><a href="#解题过程-3" class="headerlink" title="解题过程"></a>解题过程<a class="article-anchor" href="#解题过程-3" aria-hidden="true"></a></h3><p>过滤有两种解法：</p>
<ol>
<li>使用<code>WhereNode</code>过滤；</li>
<li>使用<code>FromNode</code>的节点方法<code>where()</code>过滤</li>
</ol>
<h4 id="第一种解法" class="article-heading"><a href="#第一种解法" class="headerlink" title="第一种解法"></a>第一种解法<a class="article-anchor" href="#第一种解法" aria-hidden="true"></a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//cpu.tick</span></span><br><span class="line">dbrp <span class="string">&quot;telegraf&quot;</span>.<span class="string">&quot;autogen&quot;</span></span><br><span class="line"></span><br><span class="line">stream</span><br><span class="line">  |<span class="title function_">from</span>()</span><br><span class="line">    .<span class="title function_">measurement</span>(<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">  |<span class="title function_">where</span>(<span class="attr">lambda</span>: <span class="string">&quot;cpu&quot;</span> == <span class="string">&#x27;cpu-total&#x27;</span>)</span><br><span class="line">  |<span class="title function_">window</span>()</span><br><span class="line">    .<span class="title function_">period</span>(10m)</span><br><span class="line">    .<span class="title function_">every</span>(5m)</span><br><span class="line">  |<span class="title function_">mean</span>(<span class="string">&#x27;usage_user&#x27;</span>)</span><br><span class="line">    .<span class="title function_">as</span>(<span class="string">&#x27;mean_usage_user&#x27;</span>)</span><br><span class="line">    |<span class="title function_">log</span>()</span><br></pre></td></tr></table></figure>
<p>DAG图</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">graph LR;</span><br><span class="line">  A(StreamNode)--&gt;B</span><br><span class="line">  B(FromNode)--&gt;C</span><br><span class="line">  C(WhereNode)--&gt;D</span><br><span class="line">  D(WindowNode)--&gt;E</span><br><span class="line">  E(InfluxQLNode)--&gt;F</span><br><span class="line">  F(LogNode)</span><br></pre></td></tr></table></figure>
<p>该解法，一共有6个节点。</p>
<h4 id="第二种解法" class="article-heading"><a href="#第二种解法" class="headerlink" title="第二种解法"></a>第二种解法<a class="article-anchor" href="#第二种解法" aria-hidden="true"></a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//cpu.tick</span></span><br><span class="line">dbrp <span class="string">&quot;telegraf&quot;</span>.<span class="string">&quot;autogen&quot;</span></span><br><span class="line"></span><br><span class="line">stream</span><br><span class="line">  |<span class="title function_">from</span>()</span><br><span class="line">    .<span class="title function_">measurement</span>(<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">    .<span class="title function_">where</span>(<span class="attr">lambda</span>: <span class="string">&quot;cpu&quot;</span> == <span class="string">&#x27;cpu-total&#x27;</span>)</span><br><span class="line">  |<span class="title function_">window</span>()</span><br><span class="line">    .<span class="title function_">period</span>(10m)</span><br><span class="line">    .<span class="title function_">every</span>(5m)</span><br><span class="line">  |<span class="title function_">mean</span>(<span class="string">&#x27;usage_user&#x27;</span>)</span><br><span class="line">    .<span class="title function_">as</span>(<span class="string">&#x27;mean_usage_user&#x27;</span>)</span><br><span class="line">  |<span class="title function_">log</span>()</span><br></pre></td></tr></table></figure>
<p>DAG图</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">graph LR;</span><br><span class="line">  A(StreamNode)--&gt;B</span><br><span class="line">  B(FromNode)--&gt;C</span><br><span class="line">  C(WindowNode)--&gt;D</span><br><span class="line">  D(InfluxQLNode)--&gt;E</span><br><span class="line">  E(LogNode)</span><br></pre></td></tr></table></figure>
<p>该解法保持5个节点。</p>
<h2 id="创建一个可以触发告警的-Stream-Task" class="article-heading"><a href="#创建一个可以触发告警的-Stream-Task" class="headerlink" title="创建一个可以触发告警的 Stream Task"></a>创建一个可以触发告警的 Stream Task<a class="article-anchor" href="#创建一个可以触发告警的-Stream-Task" aria-hidden="true"></a></h2><h3 id="Stream-Task-要求-4" class="article-heading"><a href="#Stream-Task-要求-4" class="headerlink" title="Stream Task 要求"></a>Stream Task 要求<a class="article-anchor" href="#Stream-Task-要求-4" aria-hidden="true"></a></h3><p>在之前<code>cpu</code>任务的基础上，如果<code>mean_usage_user &gt; 80</code>则发出严重告警。</p>
<h3 id="解题过程-4" class="article-heading"><a href="#解题过程-4" class="headerlink" title="解题过程"></a>解题过程<a class="article-anchor" href="#解题过程-4" aria-hidden="true"></a></h3><h4 id="1-画出DAG图-3" class="article-heading"><a href="#1-画出DAG图-3" class="headerlink" title="1. 画出DAG图"></a>1. 画出DAG图<a class="article-anchor" href="#1-画出DAG图-3" aria-hidden="true"></a></h4><p>DAG图</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">graph LR;</span><br><span class="line">  A(StreamNode)--&gt;B</span><br><span class="line">  B(FromNode)--&gt;C</span><br><span class="line">  C(WindowNode)--&gt;D</span><br><span class="line">  D(InfluxQLNode)--&gt;E</span><br><span class="line">  E(LogNode)--&gt; F</span><br><span class="line">  F(AlertNode)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="2-编写-TICKscript-3" class="article-heading"><a href="#2-编写-TICKscript-3" class="headerlink" title="2. 编写 TICKscript"></a>2. 编写 TICKscript<a class="article-anchor" href="#2-编写-TICKscript-3" aria-hidden="true"></a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//cpu.tick</span></span><br><span class="line">dbrp <span class="string">&quot;telegraf&quot;</span>.<span class="string">&quot;autogen&quot;</span></span><br><span class="line"></span><br><span class="line">stream</span><br><span class="line">  |<span class="title function_">from</span>()</span><br><span class="line">    .<span class="title function_">measurement</span>(<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">    .<span class="title function_">where</span>(<span class="attr">lambda</span>: <span class="string">&quot;cpu&quot;</span> == <span class="string">&#x27;cpu-total&#x27;</span>)</span><br><span class="line">    .<span class="title function_">groupBy</span>(*)</span><br><span class="line">  |<span class="title function_">window</span>()</span><br><span class="line">    .<span class="title function_">period</span>(10m)</span><br><span class="line">    .<span class="title function_">every</span>(5m)</span><br><span class="line">  |<span class="title function_">mean</span>(<span class="string">&#x27;usage_user&#x27;</span>)</span><br><span class="line">    .<span class="title function_">as</span>(<span class="string">&#x27;mean_usage_user&#x27;</span>)</span><br><span class="line">  |<span class="title function_">log</span>()</span><br><span class="line">  |<span class="title function_">alert</span>()</span><br><span class="line">    .<span class="title function_">crit</span>(<span class="attr">lambda</span>: <span class="string">&quot;mean_usage_user&quot;</span> &gt; <span class="number">80</span>)</span><br><span class="line">    .<span class="title function_">message</span>(<span class="string">&#x27;CPU is to high!&#x27;</span>)</span><br><span class="line">    .<span class="title function_">email</span>(<span class="string">&#x27;rgweiyaping@hotmail.com&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="3-启动后查看日志" class="article-heading"><a href="#3-启动后查看日志" class="headerlink" title="3. 启动后查看日志"></a>3. 启动后查看日志<a class="article-anchor" href="#3-启动后查看日志" aria-hidden="true"></a></h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@tick:/var/lib/kapacitor/task]<span class="comment"># kapacitor watch cpu</span></span><br><span class="line">ts=2019-09-08T22:23:10.011+08:00 lvl=info msg=point service=kapacitor task_master=main task=cpu node=alert5 prefix= name=cpu db= rp= group=cpu=cpu-total,host=influxdb dimension_0=cpu dimension_1=host tag_cpu=cpu-total tag_host=influxdb field_mean_usage_user=1.212475959527466 time=2019-09-08T14:23:00Z</span><br><span class="line">ts=2019-09-08T22:23:10.011+08:00 lvl=debug msg=<span class="string">&quot;alert triggered&quot;</span> service=kapacitor task_master=main task=cpu node=alert5 level=CRITICAL <span class="built_in">id</span>=cpu:cpu=cpu-total,host=influxdb event_message=<span class="string">&quot;CPU is to high!&quot;</span> data=<span class="string">&quot;&amp;&#123;cpu map[host:influxdb cpu:cpu-total] [time mean_usage_user] [[2019-09-08 14:23:00 +0000 UTC 1.212475959527466]]&#125;&quot;</span></span><br><span class="line">ts=2019-09-08T22:23:10.012+08:00 lvl=error msg=<span class="string">&quot;failed to send email&quot;</span> service=smtp task=cpu err=<span class="string">&quot;service is not enabled&quot;</span></span><br></pre></td></tr></table></figure>
<p>从日志中可以看到<code>data=&quot;&amp;&#123;cpu map[host:influxdb cpu:cpu-total] [time mean_usage_user] [[2019-09-08 14:23:00 +0000 UTC 1.212475959527466]]&#125;&quot;</code></p>
<p><code>groupBy()</code>方法分组后可以将Tag输出到data中。</p>
<h2 id="创建一个批处理的CPU任务" class="article-heading"><a href="#创建一个批处理的CPU任务" class="headerlink" title="创建一个批处理的CPU任务"></a>创建一个批处理的CPU任务<a class="article-anchor" href="#创建一个批处理的CPU任务" aria-hidden="true"></a></h2><h3 id="Batch-Task-要求" class="article-heading"><a href="#Batch-Task-要求" class="headerlink" title="Batch Task  要求"></a>Batch Task  要求<a class="article-anchor" href="#Batch-Task-要求" aria-hidden="true"></a></h3><p>批量获取 Influxdb数据库中</p>
<ul>
<li>库名<code>database</code>：<code>telegraf</code>.<code>autogen</code></li>
<li>测量名<code>measurement</code>：<code>cpu</code></li>
<li>时间窗口为：<code>2min</code></li>
<li>计算<code>usage_user</code>近1分钟的平均值</li>
</ul>
<p>输出到日志中；</p>
<h3 id="解题过程-5" class="article-heading"><a href="#解题过程-5" class="headerlink" title="解题过程"></a>解题过程<a class="article-anchor" href="#解题过程-5" aria-hidden="true"></a></h3><h4 id="1-画出DAG图-4" class="article-heading"><a href="#1-画出DAG图-4" class="headerlink" title="1. 画出DAG图"></a>1. 画出DAG图<a class="article-anchor" href="#1-画出DAG图-4" aria-hidden="true"></a></h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">graph LR;</span><br><span class="line">  A(BatchNode)--&gt;B</span><br><span class="line">  B(QueryNode)--&gt;C</span><br><span class="line">  C(InfluxQLNode)--&gt;D</span><br><span class="line">  D(LogNode)</span><br></pre></td></tr></table></figure>
<h4 id="2-编写-TICKscript-4" class="article-heading"><a href="#2-编写-TICKscript-4" class="headerlink" title="2. 编写 TICKscript"></a>2. 编写 TICKscript<a class="article-anchor" href="#2-编写-TICKscript-4" aria-hidden="true"></a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// cpu.tick</span></span><br><span class="line">dbrp <span class="string">&quot;telegraf&quot;</span>.<span class="string">&quot;autogen&quot;</span></span><br><span class="line"></span><br><span class="line">batch</span><br><span class="line">    |<span class="title function_">query</span>(<span class="string">&#x27;&#x27;</span><span class="string">&#x27;select mean(usage_user) as mean_usage_user from telegraf.autogen.cpu where cpu = &#x27;</span>cpu-total<span class="string">&#x27;</span></span><br><span class="line"><span class="string">         &#x27;</span><span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        .<span class="title function_">period</span>(2m)</span><br><span class="line">        .<span class="title function_">every</span>(1m)</span><br><span class="line">    |<span class="title function_">log</span>()</span><br></pre></td></tr></table></figure>
<h4 id="3-启动后查看日志-1" class="article-heading"><a href="#3-启动后查看日志-1" class="headerlink" title="3. 启动后查看日志"></a>3. 启动后查看日志<a class="article-anchor" href="#3-启动后查看日志-1" aria-hidden="true"></a></h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@tick:/var/lib/kapacitor/task]<span class="comment"># kapacitor watch cpu</span></span><br><span class="line">ts=2019-09-08T22:07:29.562+08:00 lvl=debug msg=<span class="string">&quot;starting next batch query&quot;</span> service=kapacitor task_master=main task=cpu node=log2 query=<span class="string">&quot;SELECT mean(usage_user) AS mean_usage_user FROM telegraf.autogen.cpu WHERE cpu = &#x27;cpu-total&#x27; AND time &gt;= &#x27;2019-09-08T14:05:29.562830856Z&#x27; AND time &lt; &#x27;2019-09-08T14:07:29.562830856Z&#x27;&quot;</span></span><br><span class="line">ts=2019-09-08T22:07:29.564+08:00 lvl=info msg=<span class="string">&quot;begin batch&quot;</span> service=kapacitor task_master=main task=cpu node=log2 prefix= name=cpu group=  time=2019-09-08T22:07:29.562830856+08:00</span><br><span class="line">ts=2019-09-08T22:07:29.564+08:00 lvl=info msg=<span class="string">&quot;batch point&quot;</span> service=kapacitor task_master=main task=cpu node=log2 prefix= name=cpu group=  field_mean_usage_user=1.1829510136651877 time=2019-09-08T14:05:29.562830856Z</span><br><span class="line">ts=2019-09-08T22:07:29.564+08:00 lvl=info msg=<span class="string">&quot;end batch&quot;</span> service=kapacitor task_master=main task=cpu node=log2 prefix= name=cpu group=  time=2019-09-08T22:07:29.562830856+08:00</span><br><span class="line">ts=2019-09-08T22:08:29.562+08:00 lvl=debug msg=<span class="string">&quot;starting next batch query&quot;</span> service=kapacitor task_master=main task=cpu node=log2 query=<span class="string">&quot;SELECT mean(usage_user) AS mean_usage_user FROM telegraf.autogen.cpu WHERE cpu = &#x27;cpu-total&#x27; AND time &gt;= &#x27;2019-09-08T14:06:29.562830788Z&#x27; AND time &lt; &#x27;2019-09-08T14:08:29.562830788Z&#x27;&quot;</span></span><br><span class="line">ts=2019-09-08T22:08:29.564+08:00 lvl=info msg=<span class="string">&quot;begin batch&quot;</span> service=kapacitor task_master=main task=cpu node=log2 prefix= name=cpu group=  time=2019-09-08T22:08:29.562830788+08:00</span><br><span class="line">ts=2019-09-08T22:08:29.564+08:00 lvl=info msg=<span class="string">&quot;batch point&quot;</span> service=kapacitor task_master=main task=cpu node=log2 prefix= name=cpu group=  field_mean_usage_user=1.1247909374907248 time=2019-09-08T14:06:29.562830788Z</span><br><span class="line">ts=2019-09-08T22:08:29.564+08:00 lvl=info msg=<span class="string">&quot;end batch&quot;</span> service=kapacitor task_master=main task=cpu node=log2 prefix= name=cpu group=  time=2019-09-08T22:08:29.562830788+08:00</span><br></pre></td></tr></table></figure>
<h2 id="总结" class="article-heading"><a href="#总结" class="headerlink" title="总结"></a>总结<a class="article-anchor" href="#总结" aria-hidden="true"></a></h2><h3 id="创建一个生产环境中设定的告警规则" class="article-heading"><a href="#创建一个生产环境中设定的告警规则" class="headerlink" title="创建一个生产环境中设定的告警规则"></a>创建一个生产环境中设定的告警规则<a class="article-anchor" href="#创建一个生产环境中设定的告警规则" aria-hidden="true"></a></h3><p>cpu的指标是1分钟采集一次，告警规则为：</p>
<p>每分钟检测一次，获取近五分钟的cpu空闲平均值，</p>
<p>如果使用率超过90%，且持续5分钟，则告警。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">graph LR;</span><br><span class="line">  A(StreamNode)--&gt;B</span><br><span class="line">  B(FromNode)--&gt;C</span><br><span class="line">  C(WindowNode)--&gt;D</span><br><span class="line">  D(InfluxQLNode)--&gt;E</span><br><span class="line">  E(EvalNode)--&gt;F</span><br><span class="line">  F(LogNode)--&gt; G</span><br><span class="line">  G(AlertNode)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//cpu_alert_stream.tick</span></span><br><span class="line">dbrp <span class="string">&quot;telegraf&quot;</span>.<span class="string">&quot;autogen&quot;</span></span><br><span class="line"></span><br><span class="line">stream</span><br><span class="line">    |<span class="title function_">from</span>()</span><br><span class="line">      .<span class="title function_">measurement</span>(<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">      .<span class="title function_">groupBy</span>(*)</span><br><span class="line">    |<span class="title function_">window</span>()</span><br><span class="line">      .<span class="title function_">period</span>(5m)</span><br><span class="line">      .<span class="title function_">every</span>(1m)            </span><br><span class="line">    |<span class="title function_">mean</span>(<span class="string">&#x27;usage_idle&#x27;</span>)</span><br><span class="line">      .<span class="title function_">as</span>(<span class="string">&#x27;mean_usage_idle&#x27;</span>)</span><br><span class="line">    |<span class="built_in">eval</span>(<span class="attr">lambda</span>: <span class="number">100.0</span> - <span class="title function_">float</span>(<span class="string">&quot;mean_usage_idle&quot;</span>))</span><br><span class="line">      .<span class="title function_">as</span>(<span class="string">&#x27;cpu_usage&#x27;</span>)</span><br><span class="line">      .<span class="title function_">keep</span>()</span><br><span class="line">    |<span class="title function_">log</span>()</span><br><span class="line">    |<span class="title function_">alert</span>()</span><br><span class="line">      .<span class="title function_">crit</span>(<span class="attr">lambda</span>: <span class="title function_">float</span>(<span class="string">&quot;cpu_usage&quot;</span>) &gt; <span class="number">90.0</span>)</span><br><span class="line">      .<span class="title function_">stateChangesOnly</span>() <span class="comment">//发送状态更改的事件。每个不同的警报级别OK，INFO，WARNING和CRITICAL都被视为不同的状态。</span></span><br><span class="line">      .<span class="title function_">message</span>(<span class="string">&#x27;&#123;                                                                                                 </span></span><br><span class="line"><span class="string">      &quot;type&quot;: &quot;cpu_usage&quot;,</span></span><br><span class="line"><span class="string">      &quot;id&quot;: &quot;主机 CPU 使用率大于90%&quot;,</span></span><br><span class="line"><span class="string">      &quot;host&quot;: &quot;&#123;&#123; index .Tags &quot;host&quot; &#125;&#125;&quot;,                                                                           </span></span><br><span class="line"><span class="string">      &quot;description&quot;: &quot;主机&#123;&#123; index .Tags &quot;host&quot; &#125;&#125; CPU使用率&#123;&#123; index .Fields &quot;cpu_usage&quot; | printf &quot;%0.2f&quot; &#125;&#125;%,CPU负载过高会导致服务器运行缓慢，应用无法正常使用等问题。请查看CPU使用率高的进程/应用是否为异常导致&quot;</span></span><br><span class="line"><span class="string">    &#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Debug 该脚本时，将大于90.0改为0.0</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@tick:/var/lib/kapacitor/task]<span class="comment"># kapacitor watch cpu_alert_stream</span></span><br><span class="line">ts=2019-09-08T22:45:10.018+08:00 lvl=info msg=point service=kapacitor task_master=main task=cpu_alert_stream node=alert6 prefix= name=cpu db= rp= group=cpu=cpu-total,host=influxdb dimension_0=cpu dimension_1=host tag_cpu=cpu-total tag_host=influxdb field_mean_usage_idle=97.94331577862968 field_cpu_usage=2.0566842213703183 time=2019-09-08T14:45:00Z</span><br><span class="line">ts=2019-09-08T22:45:10.019+08:00 lvl=debug msg=<span class="string">&quot;alert triggered&quot;</span> service=kapacitor task_master=main task=cpu_alert_stream node=alert6 level=CRITICAL <span class="built_in">id</span>=cpu:cpu=cpu-total,host=influxdb event_message=<span class="string">&quot;&#123;                                                                                                 \n      \&quot;type\&quot;: \&quot;cpu_usage\&quot;,\n      \&quot;id\&quot;: \&quot;主机 CPU 使用率大于90%\&quot;,\n      \&quot;host\&quot;: \&quot;influxdb\&quot;,                                                                           \n      \&quot;description\&quot;: \&quot;主机influxdb CPU使用率2.06%,CPU负载过高会导致服务器运行缓慢，应用无法正常使用等问题。请查看CPU使用率高的进程/应用是否为异常导致\&quot;\n    &#125;&quot;</span> data=<span class="string">&quot;&amp;&#123;cpu map[cpu:cpu-total host:influxdb] [time cpu_usage mean_usage_idle] [[2019-09-08 14:45:00 +0000 UTC 2.0566842213703183 97.94331577862968]]&#125;&quot;</span></span><br></pre></td></tr></table></figure>

              </div>
              <footer class="article-footer">
                <time class="article-footer-updated" datetime="2022-03-22T03:27:48.277Z" itemprop="dateModified">上次更新：2022-03-22</time>
                <a href="/linux/0_linux_base/index.html" class="article-footer-next" title="概览"><span>下一页</span><i class="fa fa-chevron-right"></i></a>
              </footer>
              
<section id="comments">
  <div id="disqus_thread"></div>
</section>
<script>
  var disqus_shortname = 'www-toberoot-com';
  var disqus_url = 'http://www.toberoot.com/linux/5_tick/kapacitor/05_Kapacitor%E7%9B%91%E6%8E%A7%E6%A1%88%E4%BE%8B/01_%E4%BB%8E%E4%B8%80%E4%B8%AA%E6%9C%80%E5%9F%BA%E6%9C%AC%E7%9A%84cpu.alert%E5%BC%80%E5%A7%8B.html';
  var disqus_title = "05-Kapacitor监控案例-A-从一个最基本的cpu.alert开始";
  var disqus_config = function(){
    this.language = 'zh';
  };
  (function(){
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'https://go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

            </div>
          </div>
          <aside id="article-toc" role="navigation">
            <div id="article-toc-inner">
              
<div id="carbonads">
<span>
<span class="carbon-wrap">
<a href="https://github.com/booboowei" class="carbon-img" target="_blank" rel="noopener sponsored external nofollow noreferrer">
    <img src="https://avatars2.githubusercontent.com/u/21328020?s=460&u=88cf6127c32932188f936d05636b7b0d36783ee1&v=4"
    alt="ads via Carbon" border="0" style="max-width: 130px;">
</a>
<a href="/about/" class="carbon-text" target="_blank" rel="noopener sponsored">除了自己的无知，我什么都不知道</a>
</span>
</span>

              <strong class="sidebar-title">目录</strong>
              <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8E%E4%B8%80%E4%B8%AA%E6%9C%80%E5%9F%BA%E6%9C%AC%E7%9A%84CPU-Alert%E5%BC%80%E5%A7%8B"><span class="toc-text">从一个最基本的CPU Alert开始</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E4%B9%8B%E5%89%8D"><span class="toc-text">开始之前</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E8%8C%83%E6%95%B0%E6%8D%AE"><span class="toc-text">示范数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tickscript-%E8%AF%AD%E8%A8%80"><span class="toc-text">Tickscript 语言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4"><span class="toc-text">基础命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84-Stream-Task"><span class="toc-text">创建一个最简单的 Stream Task</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Stream-Task-%E8%A6%81%E6%B1%82"><span class="toc-text">Stream Task 要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E8%BF%87%E7%A8%8B"><span class="toc-text">解题过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%94%BB%E5%87%BADAG%E5%9B%BE"><span class="toc-text">1. 画出DAG图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%BC%96%E5%86%99-TICKscript"><span class="toc-text">2. 编写 TICKscript</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%A3%B0%E6%98%8E%E8%84%9A%E6%9C%AC"><span class="toc-text">3. 声明脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%9F%A5%E7%9C%8BTask"><span class="toc-text">4. 查看Task</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8C%85%E5%90%AB%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A3%B0%E6%98%8E%E7%9A%84-Stream-Task"><span class="toc-text">创建一个包含数据库声明的 Stream Task</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Stream-Task-%E8%A6%81%E6%B1%82-1"><span class="toc-text">Stream Task 要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E8%BF%87%E7%A8%8B-1"><span class="toc-text">解题过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%94%BB%E5%87%BADAG%E5%9B%BE-1"><span class="toc-text">1. 画出DAG图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%BC%96%E5%86%99-TICKscript-1"><span class="toc-text">2. 编写 TICKscript</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%A3%B0%E6%98%8E%E8%84%9A%E6%9C%AC-1"><span class="toc-text">3. 声明脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%9F%A5%E7%9C%8BTask-1"><span class="toc-text">4. 查看Task</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-CPU-Task-%E4%BB%BB%E5%8A%A1"><span class="toc-text">启动 CPU Task 任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E8%AF%B4%E6%98%8E"><span class="toc-text">任务说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BE%E5%A0%82%E7%BB%83%E4%B9%A0"><span class="toc-text">课堂练习</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2-CPU-Task-%E4%BB%BB%E5%8A%A1"><span class="toc-text">停止 CPU Task 任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E8%AF%B4%E6%98%8E-1"><span class="toc-text">任务说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BE%E5%A0%82%E7%BB%83%E4%B9%A0-1"><span class="toc-text">课堂练习</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%B8%A6%E6%97%B6%E9%97%B4%E7%AA%97%E5%8F%A3%E7%9A%84-Stream-Task"><span class="toc-text">创建一个带时间窗口的 Stream Task</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Stream-Task-%E8%A6%81%E6%B1%82-2"><span class="toc-text">Stream Task 要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E8%BF%87%E7%A8%8B-2"><span class="toc-text">解题过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%94%BB%E5%87%BADAG%E5%9B%BE-2"><span class="toc-text">1. 画出DAG图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%BC%96%E5%86%99-TICKscript-2"><span class="toc-text">2. 编写 TICKscript</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%A3%B0%E6%98%8E%E8%84%9A%E6%9C%AC-2"><span class="toc-text">3. 声明脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%90%AF%E5%8A%A8Task"><span class="toc-text">4. 启动Task</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E6%9F%A5%E7%9C%8BTask%E5%88%97%E8%A1%A8"><span class="toc-text">5. 查看Task列表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E6%9F%A5%E7%9C%8BTask%E4%BB%BB%E5%8A%A1%E6%98%8E%E7%BB%86"><span class="toc-text">6. 查看Task任务明细</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E6%9F%A5%E7%9C%8BTask%E6%97%A5%E5%BF%97"><span class="toc-text">7. 查看Task日志</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%B8%A6%E8%BF%87%E6%BB%A4%E6%9D%A1%E4%BB%B6%E7%9A%84-Stream-Task"><span class="toc-text">创建一个带过滤条件的 Stream Task</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Stream-Task-%E8%A6%81%E6%B1%82-3"><span class="toc-text">Stream Task 要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E8%BF%87%E7%A8%8B-3"><span class="toc-text">解题过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8D%E8%A7%A3%E6%B3%95"><span class="toc-text">第一种解法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8D%E8%A7%A3%E6%B3%95"><span class="toc-text">第二种解法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8F%AF%E4%BB%A5%E8%A7%A6%E5%8F%91%E5%91%8A%E8%AD%A6%E7%9A%84-Stream-Task"><span class="toc-text">创建一个可以触发告警的 Stream Task</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Stream-Task-%E8%A6%81%E6%B1%82-4"><span class="toc-text">Stream Task 要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E8%BF%87%E7%A8%8B-4"><span class="toc-text">解题过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%94%BB%E5%87%BADAG%E5%9B%BE-3"><span class="toc-text">1. 画出DAG图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%BC%96%E5%86%99-TICKscript-3"><span class="toc-text">2. 编写 TICKscript</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%90%AF%E5%8A%A8%E5%90%8E%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97"><span class="toc-text">3. 启动后查看日志</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%89%B9%E5%A4%84%E7%90%86%E7%9A%84CPU%E4%BB%BB%E5%8A%A1"><span class="toc-text">创建一个批处理的CPU任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Batch-Task-%E8%A6%81%E6%B1%82"><span class="toc-text">Batch Task  要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E8%BF%87%E7%A8%8B-5"><span class="toc-text">解题过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%94%BB%E5%87%BADAG%E5%9B%BE-4"><span class="toc-text">1. 画出DAG图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%BC%96%E5%86%99-TICKscript-4"><span class="toc-text">2. 编写 TICKscript</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%90%AF%E5%8A%A8%E5%90%8E%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97-1"><span class="toc-text">3. 启动后查看日志</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E8%AE%BE%E5%AE%9A%E7%9A%84%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99"><span class="toc-text">创建一个生产环境中设定的告警规则</span></a></li></ol></li></ol></li></ol>
              <a href="#" id="article-toc-top">回到顶部</a>
            </div>
          </aside>
        </div>
      </article>
      <aside id="sidebar" role="navigation">
  <div class="inner">
    <strong class="sidebar-title">Linux 中级</strong><a href="/linux/0_linux_base/index.html" class="sidebar-link">概览</a><a href="/linux/0_linux_base/booboo_linux_base/index.html" class="sidebar-link">Linux 基础</a><a href="/linux/0_linux_base/booboo_easy_service/index.html" class="sidebar-link">Linux 简易服务</a><a href="/linux/0_linux_base/booboo_bash_shell_scripts/index.html" class="sidebar-link">Linux 脚本编程</a><a href="/linux/0_linux_base/booboo_middle_service/index.html" class="sidebar-link">Linux 进阶</a><strong class="sidebar-title">Linux 日常</strong><a href="/linux/1_linux_dayday/index.html" class="sidebar-link">概览</a><strong class="sidebar-title">Ex-Tools</strong><a href="/linux/2_excellent_tools/index.html" class="sidebar-link">概览</a><strong class="sidebar-title">LAMP</strong><a href="/linux/3_lamp/index.html" class="sidebar-link">概览</a><strong class="sidebar-title">Docker</strong><a href="/linux/4_docker/index.html" class="sidebar-link">概览</a><strong class="sidebar-title">TICK</strong><a href="/linux/5_tick/index.html" class="sidebar-link">概览</a><a href="/linux/5_tick/kapacitor/index.html" class="sidebar-link">Kapacitor</a>
  </div>
</aside>


    </div>
  </div>
</div>

    <footer id="footer" class="wrapper">
  <div class="inner">
    <div id="footer-copyright">
      &copy; 2022 <a href="https://github.com/hexojs/hexo/graphs/contributors" rel="external nofollow noreferrer" target="_blank">魏亚萍</a><br>
      Documentation licensed under <a href="https://choosealicense.com/licenses/agpl-3.0/" rel="external nofollow noreferrer" target="_blank">GNU AGPLv3</a><br>
      备案号：沪ICP备2020026043号
    </div>
    <div id="footer-links">
      <a href="https://github.com/BoobooWei" rel="external nofollow noreferrer" class="footer-link" target="_blank"><i class="fa fa-github-alt"></i></a>
      <a href="http://www.toberoot.com/">大宝</a><
      <a href="https://www.huangjingxue.com/" rel="external nofollow noreferrer" target="_blank">衾袭</a><
      <a href="https://husky-wu.github.io/" rel="external nofollow noreferrer" target="_blank">明夋</a><
      <a href="https://footman-ljn.github.io/" rel="external nofollow noreferrer" target="_blank">伊斯</a>
    </div>
  </div>
  <br>
  <div class="inner">
  </div>

</footer>

  </div>
  <div id="mobile-nav-dimmer"></div>
  <nav id="mobile-nav">
  <div id="mobile-nav-inner">
    <ul id="mobile-nav-list">
      <a href="/api/" class="mobile-nav-link">MySQL8.0</a><a href="/database/" class="mobile-nav-link">Database</a><a href="/devops/" class="mobile-nav-link">DevOps</a><a href="/linux/" class="mobile-nav-link">Linux</a><a href="/cloud/" class="mobile-nav-link">Cloud</a><a href="/mse/" class="mobile-nav-link">MSE</a><a href="/singapore/" class="mobile-nav-link">Singapore</a><a href="/news/" class="mobile-nav-link">News</a>
      <li class="mobile-nav-item">
        <a href="https://github.com/BoobooWei" class="mobile-nav-link" rel="external" target="_blank">GitHub</a>
      </li>
    </ul>
    
      <strong class="mobile-nav-title">Linux 中级</strong><a href="/linux/0_linux_base/index.html" class="mobile-nav-link">概览</a><a href="/linux/0_linux_base/booboo_linux_base/index.html" class="mobile-nav-link">Linux 基础</a><a href="/linux/0_linux_base/booboo_easy_service/index.html" class="mobile-nav-link">Linux 简易服务</a><a href="/linux/0_linux_base/booboo_bash_shell_scripts/index.html" class="mobile-nav-link">Linux 脚本编程</a><a href="/linux/0_linux_base/booboo_middle_service/index.html" class="mobile-nav-link">Linux 进阶</a><strong class="mobile-nav-title">Linux 日常</strong><a href="/linux/1_linux_dayday/index.html" class="mobile-nav-link">概览</a><strong class="mobile-nav-title">Ex-Tools</strong><a href="/linux/2_excellent_tools/index.html" class="mobile-nav-link">概览</a><strong class="mobile-nav-title">LAMP</strong><a href="/linux/3_lamp/index.html" class="mobile-nav-link">概览</a><strong class="mobile-nav-title">Docker</strong><a href="/linux/4_docker/index.html" class="mobile-nav-link">概览</a><strong class="mobile-nav-title">TICK</strong><a href="/linux/5_tick/index.html" class="mobile-nav-link">概览</a><a href="/linux/5_tick/kapacitor/index.html" class="mobile-nav-link">Kapacitor</a>
    
  </div>
  <div id="mobile-lang-select-wrap">
    <span id="mobile-lang-select-label"><i class="fa fa-globe"></i><span>简体中文</span></span>
    <select id="mobile-lang-select" data-canonical="">
      
        <option value="zh-cn" selected>简体中文</option>
      
    </select>
  </div>
</nav>
  <!-- Scripts -->
<!-- Cookie -->
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
<!-- build:js build/js/main.js -->

<script src="/js/lang_select.js"></script>


<script src="/js/toc.js"></script>


<script src="/js/mobile_nav.js"></script>

<!-- endbuild -->

<!-- Algolia -->

<!-- at the end of the BODY -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript">
document.getElementById('search-input-wrap').classList.add('on');
docsearch({
    apiKey: 'ad652bf20bcd81434ad119c8cf34722e',
    indexName: 'toberoot',
    inputSelector: '#search-input'
});
</script>

<!--   backup
<script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
<script type="text/javascript">
document.getElementById('search-input-wrap').classList.add('on');
docsearch({
  apiKey: 'ad652bf20bcd81434ad119c8cf34722e',
  indexName: 'toberoot',
  inputSelector: '#search-input'
});
</script>
-->

<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>
<!-- Bootstrap JS -->



</body>
</html>